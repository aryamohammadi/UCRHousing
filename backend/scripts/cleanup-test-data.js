#!/usr/bin/env node

/**
 * Cleanup Test Data Script
 * 
 * Safely removes test listings generated by seed-large.js
 * 
 * Usage:
 *   node backend/scripts/cleanup-test-data.js
 * 
 * This script removes listings created by the test data seeder.
 * It identifies test data by:
 * - Landlord email: admin@test.com
 * - Or listings created after a specific timestamp
 * 
 * SAFETY FEATURES:
 * - Shows preview of what will be deleted
 * - Requires confirmation before deletion
 * - Can run in dry-run mode to preview only
 */

require('dotenv').config();
const mongoose = require('mongoose');
const Listing = require('../models/Listing');
const Landlord = require('../models/Landlord');

const MONGODB_URI = process.env.MONGO_URL || process.env.MONGODB_URI;

if (!MONGODB_URI) {
  console.error('Set MONGODB_URI environment variable first');
  process.exit(1);
}

// Add database name if needed
let finalURI = MONGODB_URI;
if (MONGODB_URI.includes('mongodb+srv://') && !MONGODB_URI.includes('/ucrhousing') && !MONGODB_URI.includes('?')) {
  finalURI = MONGODB_URI + '/ucrhousing';
}

// Parse command line arguments
const args = process.argv.slice(2);
const dryRun = args.includes('--dry-run') || args.includes('-d');
const force = args.includes('--force') || args.includes('-f');
const byEmail = args.includes('--by-email');
const byTimestamp = args.includes('--by-timestamp');

/**
 * Find test listings by landlord email
 */
async function findTestListingsByEmail() {
  const testLandlord = await Landlord.findOne({ email: 'admin@test.com' });
  
  if (!testLandlord) {
    console.log('No test landlord found (admin@test.com)');
    return { listings: [], landlordId: null };
  }
  
  const listings = await Listing.find({ landlord: testLandlord._id });
  return { listings, landlordId: testLandlord._id };
}

/**
 * Find test listings by timestamp (last 24 hours by default)
 */
async function findTestListingsByTimestamp(hoursAgo = 24) {
  const cutoffTime = new Date(Date.now() - hoursAgo * 60 * 60 * 1000);
  const listings = await Listing.find({
    createdAt: { $gte: cutoffTime }
  }).sort({ createdAt: -1 });
  
  return listings;
}

/**
 * Preview what will be deleted
 */
function previewDeletion(listings, method) {
  console.log('\n' + '='.repeat(70));
  console.log('PREVIEW: Listings to be deleted');
  console.log('='.repeat(70));
  console.log(`Method: ${method}`);
  console.log(`Total listings: ${listings.length}`);
  
  if (listings.length === 0) {
    console.log('\nNo test listings found to delete.');
    return;
  }
  
  console.log('\nSample listings (first 10):');
  listings.slice(0, 10).forEach((listing, index) => {
    console.log(`  ${index + 1}. ${listing.title}`);
    console.log(`     Price: $${listing.price}, Bedrooms: ${listing.bedrooms}`);
    console.log(`     Created: ${listing.createdAt}`);
  });
  
  if (listings.length > 10) {
    console.log(`  ... and ${listings.length - 10} more`);
  }
  
  // Calculate total
  const totalPrice = listings.reduce((sum, listing) => sum + (listing.price || 0), 0);
  console.log(`\nTotal monthly rent value: $${totalPrice.toLocaleString()}`);
  console.log('='.repeat(70));
}

/**
 * Delete listings
 */
async function deleteListings(listings, landlordId) {
  if (listings.length === 0) {
    console.log('No listings to delete.');
    return { deleted: 0 };
  }
  
  const startTime = Date.now();
  
  // Delete listings
  const listingIds = listings.map(l => l._id);
  const deleteResult = await Listing.deleteMany({ _id: { $in: listingIds } });
  
  // Optionally delete test landlord if no other listings
  let landlordDeleted = false;
  if (landlordId) {
    const remainingListings = await Listing.countDocuments({ landlord: landlordId });
    if (remainingListings === 0) {
      await Landlord.deleteOne({ _id: landlordId });
      landlordDeleted = true;
    }
  }
  
  const endTime = Date.now();
  const duration = ((endTime - startTime) / 1000).toFixed(2);
  
  return {
    deleted: deleteResult.deletedCount,
    landlordDeleted,
    duration
  };
}

/**
 * Main cleanup function
 */
async function cleanupTestData() {
  try {
    console.log('Connecting to MongoDB...');
    await mongoose.connect(finalURI, { 
      serverSelectionTimeoutMS: 30000
    });
    console.log('Connected to MongoDB\n');
    
    // Get total count before cleanup
    const totalBefore = await Listing.countDocuments({});
    console.log(`Total listings in database: ${totalBefore}`);
    
    // Find test listings
    let testListings = [];
    let method = '';
    
    if (byEmail) {
      const result = await findTestListingsByEmail();
      testListings = result.listings;
      method = 'By test landlord email (admin@test.com)';
    } else if (byTimestamp) {
      const hours = parseInt(process.argv[process.argv.indexOf('--by-timestamp') + 1]) || 24;
      testListings = await findTestListingsByTimestamp(hours);
      method = `By timestamp (last ${hours} hours)`;
    } else {
      // Default: try by email first, then timestamp
      const emailResult = await findTestListingsByEmail();
      if (emailResult.listings.length > 0) {
        testListings = emailResult.listings;
        method = 'By test landlord email (admin@test.com)';
      } else {
        testListings = await findTestListingsByTimestamp(24);
        method = 'By timestamp (last 24 hours)';
      }
    }
    
    // Preview
    previewDeletion(testListings, method);
    
    if (testListings.length === 0) {
      console.log('\nNo test listings found. Nothing to clean up.');
      await mongoose.connection.close();
      process.exit(0);
    }
    
    // Dry run mode
    if (dryRun) {
      console.log('\n[DRY RUN] No data was deleted. Run without --dry-run to actually delete.');
      await mongoose.connection.close();
      process.exit(0);
    }
    
    // Confirmation (unless --force)
    if (!force) {
      console.log('\n⚠️  WARNING: This will permanently delete the listings shown above!');
      console.log('This action cannot be undone.');
      console.log('\nTo proceed, run with --force flag:');
      console.log('  node scripts/cleanup-test-data.js --force');
      console.log('\nOr press Ctrl+C to cancel.');
      console.log('Waiting 10 seconds before exiting...');
      await new Promise(resolve => setTimeout(resolve, 10000));
      await mongoose.connection.close();
      process.exit(0);
    }
    
    // Delete
    console.log('\n[DELETING] Removing test listings...');
    const result = await deleteListings(testListings, testListings[0]?.landlord);
    
    // Summary
    console.log('\n' + '='.repeat(70));
    console.log('CLEANUP COMPLETE');
    console.log('='.repeat(70));
    console.log(`Listings deleted: ${result.deleted}`);
    if (result.landlordDeleted) {
      console.log('Test landlord (admin@test.com) also deleted (no remaining listings)');
    }
    console.log(`Time taken: ${result.duration}s`);
    
    const totalAfter = await Listing.countDocuments({});
    console.log(`\nTotal listings before: ${totalBefore}`);
    console.log(`Total listings after: ${totalAfter}`);
    console.log(`Difference: ${totalBefore - totalAfter}`);
    console.log('='.repeat(70));
    
    await mongoose.connection.close();
    console.log('\nDatabase connection closed');
    process.exit(0);
  } catch (error) {
    console.error('\nError during cleanup:', error);
    console.error('Error stack:', error.stack);
    await mongoose.connection.close();
    process.exit(1);
  }
}

// Show usage
if (args.includes('--help') || args.includes('-h')) {
  console.log(`
Usage: node scripts/cleanup-test-data.js [options]

Options:
  --dry-run, -d          Preview what will be deleted without actually deleting
  --force, -f            Skip confirmation prompt (use with caution!)
  --by-email              Only delete listings by test landlord email
  --by-timestamp [hours]  Only delete listings created in last N hours (default: 24)
  --help, -h              Show this help message

Examples:
  # Preview what will be deleted
  node scripts/cleanup-test-data.js --dry-run
  
  # Delete test listings (with confirmation)
  node scripts/cleanup-test-data.js
  
  # Delete without confirmation
  node scripts/cleanup-test-data.js --force
  
  # Delete only listings from last 12 hours
  node scripts/cleanup-test-data.js --by-timestamp 12 --force
`);
  process.exit(0);
}

// Run cleanup
cleanupTestData();

