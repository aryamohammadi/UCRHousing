{% extends "base.html" %}

{% block title %}{{ listing.title }} - UCR HousingConnect{% endblock %}

{% block head %}
<style>
    .map-container {
        height: 400px;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .distance-info {
        @apply mt-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg;
    }
    
    .distance-item {
        @apply flex items-center justify-between py-2 border-b border-gray-200 dark:border-gray-700 last:border-0;
    }
    
    .distance-label {
        @apply flex items-center text-gray-600 dark:text-gray-400;
    }
    
    .distance-value {
        @apply font-medium text-ucr-blue-700 dark:text-ucr-blue-400;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Title and Price -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h1 class="text-3xl font-bold text-ucr-blue-700 dark:text-ucr-blue-400 mb-2">{{ listing.title }}</h1>
                <p class="text-2xl font-bold text-ucr-gold-600 dark:text-ucr-gold-400">${{ "%.2f"|format(listing.price) }}</p>
            </div>
            
            <!-- Property Details -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-ucr-blue-700 dark:text-ucr-blue-400 mb-4">Property Details</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="flex items-center">
                        <i class="fas fa-bed text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ listing.bedrooms }} Bedrooms</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-bath text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ listing.bathrooms }} Bathrooms</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-home text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ listing.property_type }}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-calendar text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">Available: {{ listing.available_date.strftime('%B %d, %Y') }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Description -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-ucr-blue-700 dark:text-ucr-blue-400 mb-4">Description</h2>
                <p class="text-gray-700 dark:text-gray-300 whitespace-pre-line">{{ listing.description }}</p>
            </div>
            
            <!-- Amenities -->
            {% if listing.amenities %}
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-ucr-blue-700 dark:text-ucr-blue-400 mb-4">Amenities</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    {% for amenity in listing.amenities %}
                    <div class="flex items-center">
                        <i class="fas fa-check text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ amenity.name }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Contact Information -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-ucr-blue-700 dark:text-ucr-blue-400 mb-4">Contact Information</h2>
                <div class="space-y-4">
                    <div class="flex items-center">
                        <i class="fas fa-phone text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ listing.contact_phone }}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-envelope text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">{{ listing.contact_email }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <a href="{{ url_for('listing.edit', listing_id=listing.id) }}" class="btn-outline">
                    <svg class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    Edit Listing
                </a>
                <button 
                    onclick="if(confirm('Are you sure you want to delete this listing? This cannot be undone.')) { document.getElementById('delete-form').submit(); }" 
                    class="btn bg-red-600 text-white hover:bg-red-700 focus:ring-red-500">
                    <svg class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
                <form id="delete-form" action="{{ url_for('listing.delete', listing_id=listing.id) }}" method="POST" class="hidden"></form>
            </div>
        </div>
        
        <!-- Map and Additional Info -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Map Container -->
            <div id="detail-map" class="map-container" 
                 data-lat="{{ listing.latitude }}" 
                 data-lng="{{ listing.longitude }}"
                 data-title="{{ listing.title }}"></div>
            
            <!-- Distance Information -->
            <div class="distance-info">
                <h3 class="text-lg font-semibold text-ucr-blue-700 dark:text-ucr-blue-400 mb-3">Distance to UCR</h3>
                <div class="distance-item">
                    <div class="distance-label">
                        <i class="fas fa-car text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span>Driving</span>
                    </div>
                    <span class="distance-value" id="driving-distance">Calculating...</span>
                </div>
                <div class="distance-item">
                    <div class="distance-label">
                        <i class="fas fa-walking text-ucr-blue-600 dark:text-ucr-blue-400 mr-2"></i>
                        <span>Walking</span>
                    </div>
                    <span class="distance-value" id="walking-distance">Calculating...</span>
                </div>
            </div>
            
            <!-- Posted Date -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                <p class="text-sm text-gray-500 dark:text-gray-400">Posted on</p>
                <p class="font-medium dark:text-white">{{ listing.created_at.strftime('%B %d, %Y') }}</p>
                {% if listing.created_at != listing.updated_at %}
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Updated on</p>
                <p class="font-medium dark:text-white">{{ listing.updated_at.strftime('%B %d, %Y') }}</p>
                {% endif %}
            </div>
            
            <!-- Similar Listings (placeholder) -->
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold mb-2 dark:text-white">Similar Listings</h3>
                <p class="text-gray-500 dark:text-gray-400 text-sm">Coming soon...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&callback=initDetailMap" async defer></script>
<script>
    function initDetailMap() {
        const detailMap = document.getElementById('detail-map');
        const lat = parseFloat(detailMap.getAttribute('data-lat')) || 33.9737;
        const lng = parseFloat(detailMap.getAttribute('data-lng')) || -117.3281;
        const title = detailMap.getAttribute('data-title');
        
        // Initialize the map
        const map = new google.maps.Map(detailMap, {
            center: { lat, lng },
            zoom: 15,
            styles: [
                {
                    featureType: "poi",
                    elementType: "labels",
                    stylers: [{ visibility: "off" }]
                }
            ]
        });
        
        // Add property marker
        const marker = new google.maps.Marker({
            position: { lat, lng },
            map: map,
            title: title,
            animation: google.maps.Animation.DROP
        });
        
        // Add UCR campus marker
        const ucrMarker = new google.maps.Marker({
            position: { lat: 33.9737, lng: -117.3281 },
            map: map,
            title: 'UCR Campus',
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: '#003DA5',
                fillOpacity: 1,
                strokeColor: '#FFD100',
                strokeWeight: 2
            }
        });
        
        // Initialize directions service
        const directionsService = new google.maps.DirectionsService();
        
        // Calculate distances
        const calculateDistances = async () => {
            // Calculate driving distance
            const drivingRequest = {
                origin: { lat, lng },
                destination: { lat: 33.9737, lng: -117.3281 },
                travelMode: google.maps.TravelMode.DRIVING
            };
            
            // Calculate walking distance
            const walkingRequest = {
                origin: { lat, lng },
                destination: { lat: 33.9737, lng: -117.3281 },
                travelMode: google.maps.TravelMode.WALKING
            };
            
            try {
                const [drivingResult, walkingResult] = await Promise.all([
                    directionsService.route(drivingRequest),
                    directionsService.route(walkingRequest)
                ]);
                
                document.getElementById('driving-distance').textContent = 
                    `${drivingResult.routes[0].legs[0].distance.text} (${drivingResult.routes[0].legs[0].duration.text})`;
                
                document.getElementById('walking-distance').textContent = 
                    `${walkingResult.routes[0].legs[0].distance.text} (${walkingResult.routes[0].legs[0].duration.text})`;
            } catch (error) {
                console.error('Error calculating distances:', error);
                document.getElementById('driving-distance').textContent = 'Unable to calculate';
                document.getElementById('walking-distance').textContent = 'Unable to calculate';
            }
        };
        
        // Calculate distances when map is loaded
        calculateDistances();
    }
</script>
{% endblock %} 